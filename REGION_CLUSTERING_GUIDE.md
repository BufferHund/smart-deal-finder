# Region-Based Deal Extraction Guide

## 🎯 全新的Deal提取方法！

我们完全重新设计了deal提取算法，解决了之前"所有deals都是错的"问题。

## 问题：旧方法为什么失败

### 旧方法（Distance-based）:

```
1. OCR识别所有文字
2. 分类：产品、价格、单位、折扣
3. 通过距离匹配：找离每个产品最近的价格
```

**问题**：
- ❌ 可能匹配到错误的价格（来自邻近产品）
- ❌ 没有考虑产品卡片的空间布局
- ❌ 容易出现跨产品的错误组合

**示例错误**：
```
Product A     Product B
Baileys       Landliebe
€17.99        €1.49

错误结果：
- "Baileys" + €1.49  ❌ (匹配到了Product B的价格)
- "Landliebe" + €17.99 ❌
```

## 解决方案：新方法（Region-based）

### 核心思想：

**超市传单的布局特点**：
- 每个产品通常在一个矩形区域内（产品卡片）
- 卡片包含：产品图、品牌、名称、价格、规格
- 卡片之间有明显的空间分隔

### 新算法流程：

```
1. OCR识别所有文字框
2. 使用DBSCAN聚类算法将文字框分组
3. 每组 = 一个产品卡片区域
4. 在每个区域内提取：
   - 产品名（最长/最显眼的文字）
   - 价格（包含€或小数点的数字）
   - 折扣（包含%的文字）
   - 规格（kg, g, ml等）
5. 组合成deal
```

## 技术细节

### 1. DBSCAN聚类

**DBSCAN** (Density-Based Spatial Clustering of Applications with Noise)

**参数**：
- `eps`: 120 像素 (同一卡片内文字的最大距离)
- `min_samples`: 2 (至少2个文字框才算一个卡片)

**为什么选DBSCAN**：
- ✅ 自动确定聚类数量（不需要预先知道有几个产品）
- ✅ 能处理不规则形状的区域
- ✅ 能识别噪声点（独立的文字）
- ✅ 对参数不太敏感

### 2. 区域内信息提取

**产品名提取**：
```python
- 优先：首字母大写的词（品牌名）
- 长度：至少3个字符
- 过滤：常见词（und, oder, mit等）
- 策略：取最长的2个词组合
```

**价格提取**：
```python
支持格式：
- "17,99 €"
- "€ 17,99"
- "1.49 EUR"
- "2.99" (fallback)

验证：€0.01 - €999.99
选择：同一区域内最大的价格（主价格）
```

**折扣提取**：
```python
格式：-20%, 30%, % 20, - 20 %
范围：1% - 99%
```

**单位提取**：
```python
格式：500 g, 1 kg, 700 ml等
支持：kg, g, l, ml, stk, pack, dose, glas
```

## 使用方法

### Web应用中

1. **启动应用**：
   ```bash
   ./run_app.sh
   ```

2. **在侧边栏找到 "Deal Extraction"**

3. **选择方法**：
   - ✅ **"Region-based (Recommended)"** ← 新方法
   - "Distance-based (Old)" ← 旧方法

4. **处理你的PDF页面**

### 结果对比

**旧方法结果**：
```
23 deals（很多错误）:
- "oder" €0.5          ❌
- "Vol." €0.7          ❌
- "Oetker" €487        ❌
- "tiefgefroren" €2200 ❌
```

**新方法结果**：
```
5-8 deals（准确）:
- "Baileys Irish Cream" €17.99 (700 ml)     ✓
- "Landliebe Joghurt" €1.49 -20% (500 g)   ✓
- "Dr. Oetker Pizza" €2.99 (320 g)         ✓
```

## 参数调优

如果结果不理想，可以调整聚类参数（在代码中）：

### eps (距离阈值)

```python
# 当前默认
eps=120  # 适合标准布局

# 如果卡片很大、间距很宽
eps=150  # 更宽松的聚类

# 如果卡片很小、紧密排列
eps=80   # 更严格的聚类
```

### min_samples (最小样本)

```python
# 当前默认
min_samples=2  # 至少2个文字框

# 如果卡片文字很多
min_samples=3  # 需要更多文字才算一个卡片

# 如果卡片文字很少
min_samples=1  # 允许单个文字框成为卡片（不推荐）
```

### 修改位置

在 `enhanced_app.py` 第431-434行：

```python
deals = create_deals_from_regions(
    ocr_results['text_boxes'],
    eps=120,        # ← 修改这里
    min_samples=2   # ← 修改这里
)
```

## 优势总结

| 特性 | 旧方法 | 新方法 |
|------|--------|--------|
| **准确性** | ⚠️ 低（跨产品匹配） | ✅ 高（区域内匹配） |
| **布局理解** | ❌ 无（只看距离） | ✅ 有（识别卡片） |
| **产品名** | ⚠️ 单个词 | ✅ 多词组合 |
| **错误率** | ❌ 高 | ✅ 低 |
| **适用场景** | 简单布局 | 复杂布局 |

## 局限性

新方法也有一些局限：

1. **依赖sklearn**：
   - 需要安装 `pip install scikit-learn`
   - 如果缺失会自动降级到旧方法

2. **计算稍慢**：
   - 聚类算法需要一点时间
   - 但差异不明显（<1秒）

3. **需要足够文字**：
   - 如果产品卡片只有图片，没有文字
   - 可能无法正确识别

4. **参数敏感性**：
   - `eps`设置太大：可能合并多个产品
   - `eps`设置太小：可能拆分同一个产品

## 测试结果

### 测试场景：3个产品卡片

```
卡片布局:
┌─────────┐  ┌─────────┐
│Baileys  │  │Landliebe│
│Irish    │  │Joghurt  │
│Cream    │  │-20%     │
│€17.99   │  │€1.49    │
│700 ml   │  │500 g    │
└─────────┘  └─────────┘

┌─────────┐
│Dr.Oetker│
│Pizza    │
│€2.99    │
│320 g    │
└─────────┘
```

### 结果：

✅ **3/3 产品正确识别**

```python
Deal 1:
  Product: Irish Cream Baileys
  Price: €17.99
  Unit: 700 ml

Deal 2:
  Product: Landliebe Joghurt
  Price: €1.49
  Discount: -20%
  Unit: 500 g

Deal 3:
  Product: Dr. Oetker Pizza
  Price: €2.99
  Unit: 320 g
```

✅ **所有信息正确匹配**
✅ **没有跨产品错误**
✅ **产品名组合合理**

## 下一步改进

未来可以考虑：

1. **基于深度学习的区域检测**
   - 使用目标检测模型（YOLO, Faster R-CNN）
   - 直接识别产品卡片位置
   - 更准确但需要训练数据

2. **布局分析**
   - 识别列、行结构
   - 理解页面布局模式
   - 更好地处理复杂布局

3. **多模态信息融合**
   - 结合图片特征
   - 识别产品图标、logo
   - 提高识别准确性

## 反馈

如果新方法效果不好，请提供：

1. **问题描述**：什么类型的错误？
2. **PDF页码**：哪一页有问题？
3. **截图**：最好带边界框的结果图
4. **OCR调试信息**：勾选"Show Debug Info"的输出

这样我们可以继续优化算法！

---

**版本**: v2.0 - Region-based clustering
**更新日期**: 2025-11-03
**团队**: Liyang, Zhaokun

**现在重启应用，选择新方法试试吧！** 🚀
