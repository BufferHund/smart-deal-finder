# Gemini AI Integration Guide

## 🤖 使用Google Gemini AI智能提取商品信息

SmartDeal现在支持使用Google的Gemini AI模型直接分析传单图片，提供更准确、更智能的商品信息提取！

## ✨ 为什么使用Gemini AI？

### 传统OCR方法的局限：

| 问题 | OCR方法 | Gemini AI |
|------|---------|-----------|
| 理解力 | ❌ 只识别文字 | ✅ 理解图片内容和上下文 |
| 准确性 | ⚠️ 依赖模式匹配 | ✅ 智能推理和判断 |
| 布局理解 | ⚠️ 需要聚类算法 | ✅ 自动理解产品卡片 |
| 处理复杂情况 | ❌ 容易出错 | ✅ 能处理各种布局 |
| 速度 | ✅ 快 | ⚠️ 稍慢（需要API调用） |
| 成本 | ✅ 免费 | ⚠️ 有配额限制 |

### Gemini AI的优势：

✅ **更准确**：直接理解图片，不依赖OCR和模式匹配
✅ **更智能**：能推理产品名称、价格关联
✅ **更全面**：能识别原价、折扣、规格等完整信息
✅ **更可靠**：不会出现跨产品匹配错误
✅ **更简单**：一步到位，无需调参数

## 📋 使用步骤

### 1. 获取API密钥

1. **访问Google AI Studio**
   - 网址：https://aistudio.google.com/apikey
   - 使用Google账号登录

2. **创建API密钥**
   - 点击 "Create API key"
   - 选择一个项目（或创建新项目）
   - 复制生成的API密钥

3. **免费配额**
   - Gemini 2.0 Flash: 免费15次/分钟
   - Gemini 1.5 Flash: 免费15次/分钟
   - Gemini 1.5 Pro: 免费2次/分钟
   - 完全够用于处理传单！

### 2. 配置应用

1. **启动SmartDeal**
   ```bash
   ./run_app.sh
   ```

2. **选择提取方法**
   - 在侧边栏 "Extraction Method" 中
   - 选择 **"🤖 Gemini AI (Recommended)"**

3. **输入API密钥**
   - 在 "Google AI Studio API Key" 输入框中
   - 粘贴你的API密钥
   - 密码输入，不会显示

4. **测试连接**
   - 点击 "🧪 Test Connection" 按钮
   - 看到 "✓ API key is valid!" 表示成功

5. **选择模型**
   - **gemini-2.0-flash-exp**：最新最快（推荐）
   - **gemini-1.5-pro**：最强大，理解力最好
   - **gemini-1.5-flash**：快速高效

### 3. 提取商品信息

1. **上传PDF/图片**
   - 选择你的REWE或PENNY传单
   - 选择要处理的页面

2. **点击提取按钮**
   - 按钮现在显示 "🤖 Extract with Gemini AI"
   - 等待几秒（Gemini需要处理图片）

3. **查看结果**
   - 切换到 "📊 Deals Analysis" 标签
   - 查看Gemini提取的商品信息

## 📊 输出格式

Gemini会为每个产品提取以下信息：

```json
{
  "product_name": "Baileys Irish Cream",
  "price": "17.99",
  "discount": "20",
  "unit": "700 ml",
  "original_price": "22.49"
}
```

### 字段说明：

- **product_name**: 完整产品名（包含品牌）
- **price**: 当前售价（仅数字，不含€）
- **discount**: 折扣百分比（仅数字，不含%）
- **unit**: 产品规格（如 500 g, 1 L）
- **original_price**: 原价（如果有折扣）

## 🎯 推荐模型选择

### Gemini 2.0 Flash Exp（推荐）

**适用场景**：
- ✅ 日常使用
- ✅ 清晰的传单
- ✅ 标准布局

**优点**：
- ⚡ 最快
- 🎯 准确度高
- 🆓 免费配额充足（15次/分钟）

**缺点**：
- Experimental版本，可能偶尔不稳定

### Gemini 1.5 Pro

**适用场景**：
- ✅ 复杂布局
- ✅ 低质量扫描件
- ✅ 需要最高准确度

**优点**：
- 🧠 理解力最强
- 🎯 最准确
- 🔍 能处理复杂情况

**缺点**：
- 🐌 较慢
- 📉 免费配额较少（2次/分钟）

### Gemini 1.5 Flash

**适用场景**：
- ✅ 大量页面处理
- ✅ 标准传单
- ✅ 需要速度

**优点**：
- ⚡ 快速
- 💰 配额充足
- 🎯 准确度好

**缺点**：
- 比2.0 Flash稍老

## 💡 使用技巧

### 1. 批量处理

如果要处理多页：
- 逐页处理
- 使用Gemini 2.0 Flash（最快）
- 注意免费配额限制

### 2. 复杂页面

如果页面布局复杂：
- 使用Gemini 1.5 Pro
- 给Gemini更多时间处理
- 结果会更准确

### 3. 验证结果

Gemini虽然准确，但也可能出错：
- 检查价格是否合理
- 确认产品名完整
- 查看是否有遗漏的商品

### 4. 成本控制

**免费配额**（每分钟）：
- Gemini 2.0 Flash: 15次
- Gemini 1.5 Flash: 15次
- Gemini 1.5 Pro: 2次

**建议**：
- 对于大量处理，使用Flash模型
- 对于重要页面，使用Pro模型
- 配额重置时间：每分钟

## ⚖️ Gemini vs OCR 对比

### 何时使用Gemini：

✅ **推荐场景**：
- 需要最高准确度
- 复杂布局的传单
- 有足够API配额
- 可以接受稍慢的处理

### 何时使用OCR：

✅ **推荐场景**：
- 需要完全离线处理
- 大批量快速处理
- 没有API密钥
- 简单清晰的布局

### 性能对比实例：

**REWE传单第4页**（复杂布局）：

| 方法 | 识别产品 | 准确率 | 速度 | 错误 |
|------|----------|--------|------|------|
| OCR + Distance | 23个 | ~40% | 2秒 | 很多跨产品匹配 |
| OCR + Region | 5-8个 | ~70% | 3秒 | 一些遗漏 |
| **Gemini 2.0 Flash** | **10-15个** | **~95%** | **5-8秒** | **极少** |

## 🔧 故障排除

### 问题1: "Invalid API key"

**原因**：
- API密钥输入错误
- API密钥已过期
- API密钥没有权限

**解决**：
1. 重新复制API密钥
2. 确保没有多余空格
3. 在Google AI Studio检查密钥状态

### 问题2: "Rate limit exceeded"

**原因**：
- 超过免费配额（每分钟请求数）

**解决**：
1. 等待1分钟后重试
2. 降低处理频率
3. 切换到更高配额的模型

### 问题3: "Failed to parse response"

**原因**：
- Gemini返回格式不符合预期
- 页面太复杂

**解决**：
1. 重试一次
2. 切换到Gemini 1.5 Pro
3. 查看错误详情

### 问题4: 提取结果不完整

**原因**：
- 页面上产品太多
- 某些产品文字不清晰

**解决**：
1. 使用Gemini 1.5 Pro（更强大）
2. 确保图片质量好
3. 可能需要手动补充

## 📈 最佳实践

### ✅ DO（推荐）：

1. **开始使用Gemini 2.0 Flash**
   - 快速测试
   - 大多数情况足够

2. **复杂页面用Pro**
   - 布局复杂
   - 文字密集
   - 低质量图片

3. **验证关键信息**
   - 价格是否合理
   - 产品名是否完整
   - 规格是否正确

4. **保存API密钥**
   - 使用密码管理器
   - 不要分享给他人

### ❌ DON'T（避免）：

1. ❌ **不要频繁切换模型**
   - 选定一个模型坚持使用

2. ❌ **不要一次处理太多页**
   - 注意配额限制
   - 逐页或小批次处理

3. ❌ **不要忽略错误**
   - 检查Gemini的响应
   - 验证提取结果

4. ❌ **不要上传敏感信息**
   - 图片会发送到Google服务器
   - 不要处理包含个人信息的文档

## 🔒 隐私和安全

### Google的数据处理：

- ✅ API调用通过HTTPS加密
- ⚠️ 图片会发送到Google服务器
- ✅ Google不会用你的数据训练模型（使用API时）
- ⚠️ 请阅读Google AI Studio的服务条款

### 建议：

1. **只处理公开传单**
   - 超市传单是公开信息
   - 不包含个人隐私

2. **妥善保管API密钥**
   - 不要提交到Git
   - 不要分享给他人

3. **监控使用情况**
   - 定期检查API使用量
   - 避免意外费用

## 📊 成本估算

### 免费配额：

**每月免费**（Gemini API）：
- 足够处理数百页传单
- 适合个人使用和学习

**示例**：
- 处理100页REWE传单
- 使用Gemini 2.0 Flash
- 每页约5秒
- 总时间：~8分钟
- **成本：完全免费** ✅

### 付费使用（如果需要）：

如果超过免费配额，可以考虑：
- Gemini Flash：非常便宜
- Gemini Pro：稍贵但更准确
- 具体价格见Google AI Studio

## 🚀 下一步

1. **获取API密钥**
   - https://aistudio.google.com/apikey

2. **重启应用**
   ```bash
   ./run_app.sh
   ```

3. **选择Gemini AI**
   - 输入API密钥
   - 测试连接

4. **开始提取**
   - 上传传单
   - 点击"Extract with Gemini AI"
   - 查看结果

5. **享受更准确的结果** 🎉

## 📚 相关文档

- **USAGE_TIPS.md**: OCR使用技巧
- **REGION_CLUSTERING_GUIDE.md**: 区域聚类方法
- **OCR_ENGINES_STATUS.md**: OCR引擎状态

---

**版本**: v3.0 - Gemini AI Integration
**更新日期**: 2025-11-03
**团队**: Liyang, Zhaokun

**试试Gemini AI，体验AI驱动的智能提取！** 🤖✨
