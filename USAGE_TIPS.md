# SmartDeal Usage Tips - 获取最佳识别效果

## 🎯 最新改进 (2025-11-03)

我们刚刚显著改进了实体提取和Deal识别算法！

### 改进内容：
- ✅ **更严格的价格识别**：现在必须有€符号
- ✅ **过滤无效产品**：自动过滤"oder", "und", "mit"等常见词
- ✅ **更智能的匹配**：基于垂直+水平距离，避免错误匹配
- ✅ **去重处理**：同一个价格不会被多个产品匹配

## 📋 推荐使用流程

### 1. 选择合适的OCR引擎

**Tesseract** (默认推荐)
- ✅ 最快速（2-3秒/页）
- ✅ 适合清晰的印刷品
- ✅ 德语支持优秀
- 📌 **推荐用于**: REWE、PENNY等清晰传单

**EasyOCR**
- ✅ 最准确（90-95%）
- ⚠️ 较慢（4-6秒/页）
- ✅ 处理复杂字体更好
- 📌 **推荐用于**: 艺术字体、低质量扫描件

### 2. 调整置信度阈值

**从默认值开始**: 0.5

**如果结果太少**:
- 降低到 **0.3** - 获取更多文本框
- 再降到 **0.2** - 包含低质量识别

**如果有很多错误**:
- 提高到 **0.7** - 只保留高置信度
- 再提高到 **0.8** - 最严格过滤

### 3. 选择合适的页面

**好的页面特征**:
- ✅ 清晰的产品图片
- ✅ 明显的价格标签
- ✅ 标准布局（产品名 + 价格）
- ✅ 高对比度文本

**避免的页面**:
- ❌ 纯图片广告页
- ❌ 复杂背景
- ❌ 手写文字
- ❌ 极小字体

### 4. 理解识别结果

#### 实体类型说明：

**Products (产品)**
- 至少4个字符
- 包含4+连续字母
- 首字母大写优先（品牌名）
- 自动过滤：oder, und, mit, vol, tiefgefroren等

**Prices (价格)**
- **必须**包含€符号
- 范围：€0.01 - €999.99
- 格式：1,99 € 或 €1.99
- 过滤：没有€的纯数字

**Discounts (折扣)**
- 格式：-20%, 30% 等
- 范围：1% - 99%

**Units (单位)**
- 格式：500 g, 1 kg, 1 L, 250 ml
- 支持：kg, g, l, ml, stk, pack, dose, pckg, glas

## 🎯 获取最佳结果的技巧

### ✅ DO (推荐做法)

1. **从第一页开始测试**
   - 先处理1-2页了解效果
   - 调整设置后再批量处理

2. **使用高质量PDF**
   - 优先使用官网下载的PDF
   - 避免扫描的PDF

3. **启用图像预处理**
   - 对低质量图片有帮助
   - 提高文字清晰度

4. **查看边界框**
   - 勾选 "Show Bounding Boxes"
   - 查看 "Show Text Labels"
   - 验证识别是否准确

5. **导出原始数据**
   - 使用"Extracted Data"标签
   - 导出CSV查看所有识别的文本
   - 用于后续分析和改进

### ❌ DON'T (避免做法)

1. ❌ **不要一次处理整个PDF**
   - 逐页处理更可控
   - 便于调整参数

2. ❌ **不要期望100%准确**
   - OCR不是完美的
   - 复杂布局会影响结果
   - 需要人工验证

3. ❌ **不要忽略置信度分数**
   - 低置信度(<0.5)可能不准确
   - 高置信度(>0.8)更可靠

## 📊 典型结果期望

### REWE/PENNY传单（清晰PDF）

**使用Tesseract, 置信度0.5:**
- 识别率：75-85%
- 产品识别：80-90%准确
- 价格识别：85-95%准确（必须有€符号）
- Deal匹配：70-80%准确

**改进后的期望:**
- ❌ 不再识别"oder", "vol."等词为产品
- ❌ 不再将"487", "2200"识别为价格
- ✅ 只创建有价格的Deal
- ✅ 更准确的产品-价格匹配

### 示例对比

**改进前（Page 4）:**
```
✗ 23 deals，包含很多错误:
  - "oder" €0.5
  - "Vol." €0.7
  - "Oetker" €487
  - "tiefgefroren," €487
```

**改进后（预期）:**
```
✓ 5-8 deals，更准确:
  - "Baileys" €17.99
  - "Landliebe Joghurt" €1.49 (500 g)
  - "Pizza" €2.99
```

## 🔧 常见问题解决

### 问题1: 识别的产品太多/太杂

**解决方案:**
- ✅ 提高置信度阈值到0.6-0.7
- ✅ 现在会自动过滤常见词
- ✅ 查看"Extracted Data"标签验证

### 问题2: 价格不准确

**原因:**
- 现在必须有€符号才会识别为价格
- 随机数字不再被识别

**验证:**
- 检查"Prices"标签
- 所有价格都应该有€符号
- 范围应该在€0.01-€999.99

### 问题3: Deal匹配不对

**可能原因:**
- 产品和价格距离太远
- 布局复杂（多列、重叠）

**建议:**
- 查看带边界框的图片
- 检查产品和价格的位置关系
- 考虑使用更低的置信度

### 问题4: 没有找到折扣

**检查:**
- 确认传单上确实有折扣标记（%, -20%等）
- 降低置信度阈值
- 查看"Discounts"标签

## 🚀 高级使用

### 命令行批处理

如果需要处理大量PDF：

```bash
# 1. 转换PDF到图片
python src/preprocessing/pdf_processor.py \
    --input brochures/ \
    --output images/

# 2. 批量OCR处理
for img in images/*.png; do
    python src/preprocessing/ocr_pipeline.py \
        --input "$img" \
        --output results/ \
        --engine tesseract
done
```

### 导出和分析

1. 在"Extracted Data"标签导出CSV
2. 在"Deals Analysis"标签导出JSON
3. 使用Python/Excel进一步分析：

```python
import pandas as pd

# 读取导出的deals
deals = pd.read_csv('deals.csv')

# 分析
print(f"Total deals: {len(deals)}")
print(f"Average price: €{deals['Price'].mean():.2f}")
print(f"Deals with discount: {deals['Discount'].notna().sum()}")
```

## 📈 持续改进

### 报告问题

如果发现识别问题：
1. 记录页码和问题描述
2. 导出原始OCR数据
3. 截图标注问题区域
4. 可以手动调整实体提取规则

### 自定义规则

可以在 `src/app/utils.py` 中调整：
- `extract_entities()`: 实体识别规则
- `create_deals_from_entities()`: Deal匹配逻辑
- 修改阈值、模式、过滤词等

---

**最后更新**: 2025-11-03
**版本**: v1.1 (改进的实体提取)
**团队**: Liyang, Zhaokun

**现在重新启动应用，体验改进后的识别效果！** 🎉
